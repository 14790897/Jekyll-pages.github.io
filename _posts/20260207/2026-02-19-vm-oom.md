---
title: ğŸ›¡ï¸ Proxmox VE é˜²æ­¢ OOM Killer è¯¯æ€è™šæ‹Ÿæœºçš„å®Œæ•´æŒ‡å—
date: 2026-02-19
categories:
  - tech
tags:
  - pve
  - linux
---


åœ¨ Proxmox VE (PVE) ä¸­ï¼Œä¸»æœº OOM Killer å¯èƒ½æ€æ­» QEMU è¿›ç¨‹ï¼ˆè™šæ‹Ÿæœºï¼‰ï¼Œä¿æŠ¤æ–¹æ³•åŒ…æ‹¬ hookscript è®¾ç½® oom_score_adjã€ç¦ç”¨å†…å­˜æ°”çƒå’Œä¼˜åŒ–ä¸»æœºå†…å­˜ã€‚ [reddit](https://www.reddit.com/r/Proxmox/comments/12th2ra/oomkiller_killing_only_vm_how_to_fix/)

## æ–¹æ³•1ï¼šHookscriptï¼ˆæ¨èï¼‰

åˆ›å»ºä¿æŠ¤è„šæœ¬ `/var/lib/vz/snippets/oom_protect.sh`ï¼š
```bash
#!/bin/sh
vmid=$1
phase=$2
vmpid=$(cat /run/qemu-server/$vmid.pid 2>/dev/null)

if [ "$phase" = "post-start" ]; then
    echo "ä¿æŠ¤ VM $vmid (PID $vmpid) å…äº OOM"
    echo -1000 > /proc/$vmpid/oom_score_adj
fi
```
```
chmod +x /var/lib/vz/snippets/oom_protect.sh
qm set <VMID> --hookscript local:snippets/oom_protect.sh
```
å¯åŠ¨ VM åè‡ªåŠ¨è®¾ç½® -1000ï¼ˆæ°¸ä¸æ€ï¼‰ã€‚ [gist.github](https://gist.github.com/oetiker/8e7fccee8f1f2ad87c5006d23aef872e)

## æ–¹æ³•2ï¼šSystemd è·¯å¾„å•å…ƒï¼ˆå…¨å±€ä¿æŠ¤ï¼‰

ä¸ºç‰¹å®š VMï¼ˆå¦‚ 104ï¼‰åˆ›å»ºï¼š
```bash
cat > /etc/systemd/system/104-oom.path <<EOF
[Path]
PathModified=/run/qemu-server/104.pid

[Install]
WantedBy=multi-user.target
EOF

cat > /etc/systemd/system/104-oom.service <<EOF
[Unit]
Description=Protect VM 104 from OOM

[Service]
Type=oneshot
ExecStart=/bin/sh -c 'echo -1000 >/proc/$(cat /run/qemu-server/104.pid)/oom_score_adj'
EOF

systemctl daemon-reload
systemctl enable 104-oom.path
```
æ›¿æ¢ 104 ä¸ºä½ çš„ VMIDã€‚ [gist.github](https://gist.github.com/oetiker/8e7fccee8f1f2ad87c5006d23aef872e)

## å…¶ä»–ä¼˜åŒ–

**å†…å­˜æ°”çƒ**ï¼š
- VM é€‰é¡¹ > ç¡¬ä»¶ > å†…å­˜ > å–æ¶ˆå‹¾é€‰â€œæ°”çƒâ€ï¼ˆBallooningï¼‰ï¼Œé¿å…ä¸»æœºæŠ¢å  VM å†…å­˜ã€‚ [reddit](https://www.reddit.com/r/Proxmox/comments/11xiynz/ballooning_permanently_steals_memory_from_vms/)

**ä¸»æœºè°ƒä¼˜**ï¼š
- ZFS ç”¨æˆ·ï¼š`echo 8589934592 > /sys/module/zfs/parameters/zfs_arc_max`ï¼ˆé™ ARC 8GBï¼‰
- Swapï¼šå¯ç”¨ä¸»æœº swap åˆ†æ‹…å‹åŠ›
- é¿å…è¶…é…ï¼šæ€» VM RAM < ä¸»æœº RAM 80%

**ç›‘æ§**ï¼š`watch -n1 'cat /proc/*/oom_score_adj | grep qemu'` æ£€æŸ¥åˆ†æ•°ã€‚ [reddit](https://www.reddit.com/r/Proxmox/comments/12th2ra/oomkiller_killing_only_vm_how_to_fix/)